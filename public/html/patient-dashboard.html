<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediCare - Patient Portal</title>
  <link rel="stylesheet" href="/public/css/style.css">
  <link rel="stylesheet" href="/public/css/patient-portal.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Epilogue:wght@700;800&display=swap" rel="stylesheet">

</head>
<body>
  <!-- Main Navigation -->
  <nav class="main-nav">
    <div class="nav-container">
      <a href="index.html" class="logo">
        <img src="assets/logo.png" alt="MediCare">
        <span>MediCare</span>
      </a>
      <div class="nav-links">
        <a href="about.html">About</a>
        <a href="services.html">Services</a>
        <a href="doctors.html">Our Doctors</a>
        <a href="contact.html">Contact</a>
        <div class="user-menu">
          <button class="user-btn">
            <img src="assets/patients/patient-default.jpg" alt="Patient" class="user-avatar">
            <span>John D.</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="dropdown-menu">
            <a href="#" id="profile-link">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              My Profile
            </a>
            <a href="#" id="settings-link">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Settings
            </a>
            <a href="#" id="logout">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h4"></path>
                <polyline points="17 16 21 12 17 8"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Logout
            </a>
          </div>
        </div>
      </div>
      <button class="mobile-menu-btn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>

  <!-- Patient Portal Header -->
  <header class="portal-header">
    <div class="container">
      <div class="header-content">
        <h1>Patient Portal</h1>
        <p>Manage your healthcare in one convenient place</p>
        <button class="chat-btn" id="open-chat">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          Message Your Doctor
        </button>
      </div>
      <div class="user-card">
        <div class="user-info">
          <img src="assets/patients/patient-default.jpg" alt="John Doe" class="user-avatar">
          <div>
            <h3>John Doe</h3>
            <p>Patient ID: MC123456</p>
            <p>Last visit: June 15, 2023</p>
          </div>
        </div>
        <div class="user-meta">
          <div class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            john.doe@example.com
          </div>
          <div class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
            (555) 123-4567
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Portal Content -->
  <main class="portal-main">
    <div class="container">
      <!-- Quick Access Cards -->
      <div class="quick-access">
        <div class="access-card" id="appointments-card">
          <div class="card-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <h3>Appointments</h3>
          <p>Schedule and manage visits</p>
        </div>

        <div class="access-card" id="prescriptions-card">
          <div class="card-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 2h4"></path>
              <path d="M12 2v6"></path>
              <rect x="4" y="10" width="16" height="12" rx="2"></rect>
              <path d="M9 15h6"></path>
            </svg>
          </div>
          <h3>Prescriptions</h3>
          <p>View and refill medications</p>
        </div>

        <div class="access-card" id="billing-card">
          <div class="card-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          </div>
          <h3>Billing</h3>
          <p>Payments and statements</p>
        </div>

        <div class="access-card" id="records-card">
          <div class="card-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
          </div>
          <h3>Medical Records</h3>
          <p>Test results and history</p>
        </div>
      </div>

      <!-- Recent Activity Section -->
      <section class="recent-activity">
        <h2>Recent Activity</h2>
        <div class="activity-list">
          <div class="activity-item">
            <div class="activity-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            <div class="activity-content">
              <p>Upcoming appointment with <strong>Dr. Smith</strong> on June 15</p>
              <span class="activity-time">2 days ago</span>
            </div>
          </div>
          <div class="activity-item">
            <div class="activity-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 2h4"></path>
                <path d="M12 2v6"></path>
                <rect x="4" y="10" width="16" height="12" rx="2"></rect>
                <path d="M9 15h6"></path>
              </svg>
            </div>
            <div class="activity-content">
              <p>New prescription for <strong>Lisinopril</strong> added</p>
              <span class="activity-time">1 week ago</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal Dialogs -->
<!-- Appointments Modal -->
<div class="modal" id="appointments-modal" role="dialog" aria-modal="true" aria-labelledby="appointments-modal-title">
  <div class="modal-container landscape">
    
    <!-- Modal Header -->
    <div class="modal-header">
      <h2 id="appointments-modal-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        Appointment Management
      </h2>
      <button class="close-modal" aria-label="Close appointment modal">&times;</button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body grid-layout">

      <!-- Schedule New Appointment Form -->
      <div class="form-card card-1">
        <h3>Schedule a New Appointment</h3>
        <p class="form-description">Please fill out the form below to create a new appointment. All fields are required unless stated otherwise.</p>
        <form id="new-appointment-form">
                    <div id="availability-warning" style="color: red; margin-top: 10px;"></div>


          <div class="form-group">
            <label for="appointment-type">Appointment Type <span class="required">*</span></label>
            <select id="appointment-type" name="appointment-type" required>
              <option value="">-- Select appointment type --</option>
              <option value="checkup">Routine Checkup</option>
              <option value="consultation">Consultation</option>
              <option value="followup">Follow-up Visit</option>
              <option value="urgent">Urgent Medical Care</option>
            </select>
            <small class="form-help">Choose the type that best fits your medical needs.</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="appointment-date">Preferred Date <span class="required">*</span></label>
              <input type="date" id="appointment-date" name="appointment-date" required>
              <small class="form-help">Select your preferred appointment date.</small>
            </div>
            <div class="form-group">
              <label for="appointment-time">Time Slot <span class="required">*</span></label>
              <select id="appointment-time" name="appointment-time" required>
                <option value="">-- Select time --</option>
                <option value="08:00">8:00 AM - 8:30 AM</option>
                <option value="09:00">9:00 AM - 9:30 AM</option>
                <option value="10:00">10:00 AM - 10:30 AM</option>
                <option value="11:00">11:00 AM - 11:30 AM</option>
              </select>
              <small class="form-help">Appointment times are in 30-minute intervals.</small>
            </div>
          </div>

          <div class="form-group">
            <label for="appointment-doctor">Select Doctor <span class="required">*</span></label>
            <select id="appointment-doctor" name="appointment-doctor" required>
              <option value="">-- Select doctor --</option>
              <option value="dr-smith">Dr. Amanda Smith (Cardiologist)</option>
              <option value="dr-johnson">Dr. Sarah Johnson (Pediatrician)</option>
              <option value="dr-williams">Dr. James Williams (General Practitioner)</option>
            </select>
            <small class="form-help">Select your preferred healthcare provider.</small>
          </div>

          <div class="form-group">
            <label for="appointment-reason">Reason for Visit <span class="required">*</span></label>
            <textarea id="appointment-reason" name="appointment-reason" rows="4" placeholder="Describe your symptoms or reason for the visit..." required></textarea>
            <small class="form-help">Please be specific. This helps us prepare for your appointment.</small>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Submit & Schedule</button>
          </div>

        </form>

      </div>

      

      <!-- Upcoming Appointments -->
      <div class="list-card card-2">
        <h3>Upcoming Appointments</h3>
        <p class="section-description">Here’s a list of your scheduled appointments. You can cancel or reschedule if necessary.</p>

<div class="appointment-list">
  <!-- JS will fill here -->
</div>
      </div>

      <!-- Past Appointment History -->
      <div class="history-card card-3">
        <h3>Past Appointments</h3>
        <p class="section-description">Your medical history from past visits is listed below for your reference.</p>
        <div class="history-list">
          <div class="history-item">
            <p><strong>May 15, 2023:</strong> Annual Physical Exam with Dr. Amanda Smith - General Wellness Check</p>
          </div>
          <div class="history-item">
            <p><strong>April 3, 2023:</strong> Lab Testing - Blood Panel and Urinalysis</p>
          </div>
          <div class="history-item">
            <p><strong>March 10, 2023:</strong> Follow-up Consultation - Cardiology review with Dr. Sarah Johnson</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>


  <!-- Prescriptions Modal -->
  <div class="modal" id="prescriptions-modal">
    <div class="modal-container landscape">
      <div class="modal-header">
        <h2>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 2h4"></path>
            <path d="M12 2v6"></path>
            <rect x="4" y="10" width="16" height="12" rx="2"></rect>
            <path d="M9 15h6"></path>
          </svg>
          Prescription Management
        </h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body grid-layout">
        <div class="form-card card-1">
          <h3>Request Refill</h3>
          <form id="refill-form">
            <div class="form-group">
              <label for="prescription-select">Select Prescription</label>
              <select id="prescription-select" name="prescription-select">
                <option value="">Select medication</option>
                <option value="lisinopril">Lisinopril 10mg</option>
                <option value="amlodipine">Amlodipine 5mg</option>
                <option value="metformin">Metformin 500mg</option>
              </select>
            </div>
            <div class="form-group">
              <label for="pharmacy-select">Preferred Pharmacy</label>
              <select id="pharmacy-select" name="pharmacy-select">
                <option value="">Select pharmacy</option>
                <option value="cvs-123">CVS Pharmacy - 123 Main St</option>
                <option value="walgreens-456">Walgreens - 456 Oak Ave</option>
              </select>
            </div>
            <div class="form-group">
              <label for="refill-notes">Special Instructions</label>
              <textarea id="refill-notes" name="refill-notes" rows="2"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Request Refill</button>
            </div>
          </form>
        </div>

        <div class="list-card card-2">
          <h3>Active Prescriptions</h3>
          <div class="prescription-list">
            <div class="prescription-item">
              <div class="prescription-info">
                <h4>Lisinopril 10mg</h4>
                <p>Take 1 tablet daily in the morning</p>
                <p>Prescribed by Dr. Smith on 05/15/2023</p>
              </div>
              <div class="prescription-status">
                <span class="status-badge active">Active</span>
                <span class="refill-info">2 refills remaining</span>
              </div>
            </div>
            <div class="prescription-item">
              <div class="prescription-info">
                <h4>Amlodipine 5mg</h4>
                <p>Take 1 tablet daily in the evening</p>
                <p>Prescribed by Dr. Smith on 05/15/2023</p>
              </div>
              <div class="prescription-status">
                <span class="status-badge active">Active</span>
                <span class="refill-info">1 refill remaining</span>
              </div>
            </div>
          </div>
        </div>

        <div class="history-card card-3">
          <h3>Prescription History</h3>
          <div class="history-list">
            <div class="history-item">
              <p><strong>Metformin 500mg</strong> - Completed on 04/10/2023</p>
            </div>
            <div class="history-item">
              <p><strong>Atorvastatin 20mg</strong> - Discontinued on 03/22/2023</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Billing Modal -->
  <div class="modal" id="billing-modal">
    <div class="modal-container landscape">
      <div class="modal-header">
        <h2>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
          Billing & Payments
        </h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body grid-layout">
        <div class="form-card card-1">
          <h3>Make a Payment</h3>
          <form id="payment-form">
            <div class="form-group">
              <label for="payment-amount">Amount ($)</label>
              <input type="number" id="payment-amount" name="payment-amount" min="1" step="0.01" value="150.00">
            </div>
            <div class="form-group">
              <label for="payment-method">Payment Method</label>
              <select id="payment-method" name="payment-method">
                <option value="credit-card">Credit/Debit Card</option>
                <option value="mpesa">MPESA</option>
                <option value="insurance">Insurance</option>
              </select>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Submit Payment</button>
            </div>
          </form>
        </div>

        <div class="list-card card-2">
          <h3>Payment History</h3>
          <div class="payment-list">
            <div class="payment-item">
              <div class="payment-info">
                <p><strong>June 1, 2023</strong></p>
                <p>Cardiology Consultation</p>
              </div>
              <div class="payment-amount">
                <p>$150.00</p>
                <span class="status-badge paid">Paid</span>
              </div>
            </div>
            <div class="payment-item">
              <div class="payment-info">
                <p><strong>May 15, 2023</strong></p>
                <p>Lab Tests</p>
              </div>
              <div class="payment-amount">
                <p>$75.00</p>
                <span class="status-badge paid">Paid</span>
              </div>
            </div>
          </div>
        </div>

        <div class="summary-card card-3">
          <h3>Billing Summary</h3>
          <div class="summary-item">
            <p>Outstanding Balance</p>
            <p class="amount">$0.00</p>
          </div>
          <div class="summary-item">
            <p>Last Payment</p>
            <p class="amount">$150.00</p>
          </div>
          <div class="summary-item">
            <p>Insurance Coverage</p>
            <p class="amount">80%</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Medical Records Modal -->
  <div class="modal" id="records-modal">
    <div class="modal-container landscape">
      <div class="modal-header">
        <h2>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          Medical Records
        </h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body grid-layout">
        <div class="form-card card-1">
          <h3>Request Records</h3>
          <form id="records-request-form">
            <div class="form-group">
              <label>Record Type</label>
              <div class="radio-group">
                <label>
                  <input type="radio" name="record-type" value="all" checked>
                  All Records
                </label>
                <label>
                  <input type="radio" name="record-type" value="lab">
                  Lab Results Only
                </label>
                <label>
                  <input type="radio" name="record-type" value="visit">
                  Visit Summaries Only
                </label>
              </div>
            </div>
            <div class="form-group">
              <label for="records-email">Email Address</label>
              <input type="email" id="records-email" name="records-email" value="john.doe@example.com">
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Request Records</button>
            </div>
          </form>
        </div>

        <div class="list-card card-2">
          <h3>Available Records</h3>
          <div class="records-list">
            <div class="record-item">
              <div class="record-info">
                <h4>Annual Physical Exam</h4>
                <p>June 1, 2023 - Dr. Smith</p>
              </div>
              <div class="record-actions">
                <button class="btn btn-text">View</button>
                <button class="btn btn-primary">Download</button>
              </div>
            </div>
            <div class="record-item">
              <div class="record-info">
                <h4>Blood Test Results</h4>
                <p>May 15, 2023 - LabCorp</p>
              </div>
              <div class="record-actions">
                <button class="btn btn-text">View</button>
                <button class="btn btn-primary">Download</button>
              </div>
            </div>
          </div>
        </div>

        <div class="history-card card-3">
          <h3>Record History</h3>
          <div class="history-list">
            <div class="history-item">
              <p><strong>March 10, 2023</strong> - Cardiology Follow-up Notes</p>
            </div>
            <div class="history-item">
              <p><strong>January 5, 2023</strong> - Annual Blood Work Results</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal" id="profile-modal">
    <div class="modal-container landscape">
      <div class="modal-header">
        <h2>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          My Profile
        </h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body grid-layout">
        <div class="form-card card-1">
          <h3>Personal Information</h3>
          <form id="profile-form">
            <div class="form-row">
              <div class="form-group">
                <label for="first-name">First Name</label>
                <input type="text" id="first-name" name="first-name" value="John">
              </div>
              <div class="form-group">
                <label for="last-name">Last Name</label>
                <input type="text" id="last-name" name="last-name" value="Doe">
              </div>
            </div>
            <div class="form-group">
              <label for="dob">Date of Birth</label>
              <input type="date" id="dob" name="dob" value="1985-06-15">
            </div>
            <div class="form-group">
              <label for="gender">Gender</label>
              <select id="gender" name="gender">
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>

        <div class="form-card card-2">
          <h3>Contact Information</h3>
          <form id="contact-form">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" value="john.doe@example.com">
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" id="phone" name="phone" value="(555) 123-4567">
            </div>
            <div class="form-group">
              <label for="address">Street Address</label>
              <input type="text" id="address" name="address" value="123 Main St">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" value="Nairobi">
              </div>
              <div class="form-group">
                <label for="zip">Postal Code</label>
                <input type="text" id="zip" name="zip" value="00100">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Update Contact Info</button>
            </div>
          </form>
        </div>

        <div class="form-card card-3">
          <h3>Security Settings</h3>
          <form id="security-form">
            <div class="form-group">
              <label for="current-password">Current Password</label>
              <input type="password" id="current-password" name="current-password">
            </div>
            <div class="form-group">
              <label for="new-password">New Password</label>
              <input type="password" id="new-password" name="new-password">
            </div>
            <div class="form-group">
              <label for="confirm-password">Confirm Password</label>
              <input type="password" id="confirm-password" name="confirm-password">
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Change Password</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div class="modal" id="chat-modal">
    <div class="modal-container">
      <div class="chat-header">
        <div class="doctor-info">
          <img src="assets/doctors/doctor1.jpg" alt="Dr. Smith">
          <div>
            <h3>Dr. Sarah Johnson</h3>
            <p>Cardiologist</p>
          </div>
        </div>
        <button class="close-btn" id="close-chat">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="message received">
          <div class="message-content">
            <p>Hello John, how can I help you today?</p>
            <span class="message-time">10:30 AM</span>
          </div>
        </div>
        <div class="message sent">
          <div class="message-content">
            <p>Hi Dr. Johnson, I've been experiencing headaches since yesterday afternoon</p>
            <span class="message-time">10:32 AM</span>
          </div>
        </div>
        <div class="message received">
          <div class="message-content">
            <p>I see. Are you experiencing any other symptoms like nausea, dizziness, or vision changes?</p>
            <span class="message-time">10:33 AM</span>
          </div>
        </div>
      </div>
      <div class="chat-input">
        <input type="text" placeholder="Type your message..." id="chat-input">
        <button class="send-btn" id="send-message">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script src="/public/js/patient-portal.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Fetch user object from sessionStorage
    const user = JSON.parse(sessionStorage.getItem("user"));

    // Check if user data exists
    if (user && user.fullName && user.email) {
      // Update name
      const nameElement = document.querySelector(".user-info h3");
      if (nameElement) nameElement.textContent = user.fullName;

      // Update email
      const emailElement = document.querySelector(".user-meta .meta-item:first-child");
      if (emailElement) emailElement.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
          viewBox="0 0 24 24" fill="none" stroke="currentColor" 
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 
          0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        ${user.email}
      `;

      // Optional: Replace dummy patient ID or phone if stored
      const patientIdElement = document.querySelector(".user-info p:first-of-type");
      if (patientIdElement) patientIdElement.textContent = `Patient ID: ${user._id}`;

      // You could also update phone number or visit date if available
    } else {
      console.warn("User data not found in sessionStorage.");
    }
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_BASE = 'http://localhost:8000/api/appointments';
  const USERS_API = 'http://localhost:8000/users';
  const EMAILJS_CONFIG = {
    service_id: 'service_6uu4fwd',
    template_id: 'template_welqxde',
    user_id: 'cy9YL054A1rcf2BH4'
  };

  const doctorMap = {};
  const appointmentForm = document.getElementById('new-appointment-form');
  const appointmentList = document.querySelector('.appointment-list');
  const availabilityWarning = document.getElementById('availability-warning');

  loadDoctorOptions();
  loadAppointments();

  ['appointment-date', 'appointment-time', 'appointment-doctor'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', checkDoctorAvailability);
  });

  if (appointmentForm) {
    appointmentForm.addEventListener('submit', handleNewAppointment);
  }

  function getPatientId() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    return user?._id;
  }

  function formatDateParts(isoDate) {
    const date = new Date(isoDate);
    return {
      day: date.getDate(),
      month: date.toLocaleString('default', { month: 'short' }),
      fullDate: date.toLocaleDateString(),
      isoDate
    };
  }

  function capitalize(text) {
    return text.charAt(0).toUpperCase() + text.slice(1);
  }

  function formatEndTime(startTime) {
    const [hour, minute] = startTime.split(':').map(Number);
    const date = new Date(2000, 0, 1, hour, minute + 30);
    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
  }

  async function loadDoctorOptions() {
    try {
      const res = await fetch(`${USERS_API}?role=doctor`);
      if (!res.ok) throw new Error('Doctor fetch failed');
      const users = await res.json();
      const doctors = users.filter(u => u.role === 'doctor' && u.isActive !== false);
      const select = document.getElementById('appointment-doctor');
      if (!select) return;

      select.innerHTML = '<option value="">-- Select doctor --</option>';
      doctors.forEach(doc => {
        const opt = document.createElement('option');
        opt.value = doc._id;
        opt.textContent = doc.fullName;
        select.appendChild(opt);
        doctorMap[doc._id] = doc.fullName;
      });
    } catch (err) {
      console.error('Doctor loading failed:', err);
    }
  }

  async function loadAppointments() {
    const patientId = getPatientId();
    if (!patientId || !appointmentList) return;

    try {
      const res = await fetch(`${API_BASE}?patientId=${patientId}`);
      if (!res.ok) throw new Error('Appointment fetch failed');

      const appointments = await res.json();
      const today = new Date().toISOString().split('T')[0];

      const upcoming = appointments.filter(app =>
        app.date >= today && ['pending', 'confirmed'].includes(app.status)
      );

      appointmentList.innerHTML = upcoming.length ? '' : '<p class="no-appointments">No upcoming appointments.</p>';

      upcoming.forEach(app => {
        const { day, month } = formatDateParts(app.date);
        const doctorName = doctorMap[app.doctorId] || 'Unknown Doctor';
        const div = document.createElement('div');
        div.className = 'appointment-item';
        div.innerHTML = `
          <div class="appointment-date">
            <span class="day">${day}</span>
            <span class="month">${month}</span>
          </div>
          <div class="appointment-details">
            <h4>${doctorName}</h4>
            <p><strong>Type:</strong> ${capitalize(app.appointmentType)}</p>
            <p><strong>Time:</strong> ${app.timeSlot}</p>
            <p><strong>Status:</strong> ${capitalize(app.status)}</p>
          </div>
          <div class="appointment-actions">
            <button class="btn btn-warning" onclick="rescheduleAppointment('${app._id}')">Reschedule</button>
            <button class="btn btn-danger" onclick="cancelAppointment('${app._id}')">Cancel</button>
          </div>
        `;
        appointmentList.appendChild(div);
      });
    } catch (err) {
      console.error('Appointments loading error:', err);
      appointmentList.innerHTML = `<p class="error">Failed to load appointments. Please refresh the page.</p>`;
    }
  }

  async function checkDoctorAvailability() {
    const doctorId = document.getElementById('appointment-doctor')?.value;
    const date = document.getElementById('appointment-date')?.value;
    const time = document.getElementById('appointment-time')?.value;
    const submitBtn = document.querySelector('#new-appointment-form button[type="submit"]');

    if (!doctorId || !date || !time || !submitBtn) return;

    const timeSlot = `${time}-${formatEndTime(time)}`;

    try {
      const res = await fetch(API_BASE);
      const appointments = await res.json();
      const isTaken = appointments.some(app =>
        app.doctorId === doctorId &&
        app.date === date &&
        app.timeSlot === timeSlot &&
        ['pending', 'confirmed'].includes(app.status)
      );

      if (isTaken) {
        availabilityWarning.textContent = '⚠ Slot already booked. Choose another.';
        submitBtn.disabled = true;
      } else {
        availabilityWarning.textContent = '';
        submitBtn.disabled = false;
      }
    } catch (err) {
      console.error('Availability check failed:', err);
      availabilityWarning.textContent = 'Error checking availability.';
      submitBtn.disabled = true;
    }
  }

  async function handleNewAppointment(e) {
    e.preventDefault();

    const patientId = getPatientId();
    if (!patientId) return alert('Login required.');

    const type = document.getElementById('appointment-type')?.value;
    const date = document.getElementById('appointment-date')?.value;
    const time = document.getElementById('appointment-time')?.value;
    const doctorId = document.getElementById('appointment-doctor')?.value;
    const reason = document.getElementById('appointment-reason')?.value;
    const timeSlot = `${time}-${formatEndTime(time)}`;

    if (!type || !date || !time || !doctorId || !reason) return alert('Fill all fields.');

    try {
      const res = await fetch(API_BASE);
      const appointments = await res.json();
      const isTaken = appointments.some(app =>
        app.doctorId === doctorId && app.date === date && app.timeSlot === timeSlot && ['pending', 'confirmed'].includes(app.status)
      );

      if (isTaken) return alert('Time slot already taken.');

      const payload = {
        appointmentType: type,
        patientId,
        doctorId,
        date,
        timeSlot,
        reason,
        status: 'pending'
      };

      const createRes = await fetch(API_BASE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const newApp = await createRes.json();
      const user = JSON.parse(sessionStorage.getItem('user'));

      await sendAppointmentEmail(user.email, {
        appointment_id: newApp._id,
        patient_name: user.fullName,
        doctor_name: doctorMap[doctorId],
        appointment_date: formatDateParts(date).fullDate,
        appointment_time: timeSlot,
        appointment_type: capitalize(type),
        appointment_reason: reason,
        patient_email: user.email
      }, 'confirm');

      alert('Appointment scheduled.');
      e.target.reset();
      loadAppointments();
    } catch (err) {
      console.error('Error submitting appointment:', err);
      alert('Submission failed. Try again.');
    }
  }

  async function sendAppointmentEmail(patientEmail, appointmentData, actionType) {
    const templateParams = {
      ...appointmentData,
      is_confirmation: actionType === 'confirm' ? 'true' : '',
      is_cancellation: actionType === 'cancel' ? 'true' : '',
      is_reschedule: actionType === 'reschedule' ? 'true' : ''
    };

    try {
      await fetch('https://api.emailjs.com/api/v1.0/email/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...EMAILJS_CONFIG, template_params: templateParams })
      });
    } catch (err) {
      console.error('Email failed:', err);
    }
  }

window.cancelAppointment = async (id) => {
  if (!confirm('Cancel this appointment?')) return;

  try {
    const res = await fetch(`${API_BASE}?appointmentId=${id}`);
    const appointment = await res.json();

    await fetch(`${API_BASE}?appointmentId=${id}`, { method: 'DELETE' });

    const user = JSON.parse(sessionStorage.getItem('user'));
    await sendAppointmentEmail(user.email, {
      appointment_id: id,
      patient_name: user.fullName,
      doctor_name: doctorMap[appointment.doctorId],
      appointment_date: formatDateParts(appointment.date).fullDate,
      appointment_time: appointment.timeSlot,
      appointment_type: capitalize(appointment.appointmentType),
      appointment_reason: appointment.reason,
      patient_email: user.email
    }, 'cancel');

    // Remove from DOM instantly
    const appointmentDiv = document.querySelector(`.appointment-item button.btn-danger[onclick*="${id}"]`)?.closest('.appointment-item');
    if (appointmentDiv) appointmentDiv.remove();

    // If no more appointments, show fallback
    if (appointmentList.children.length === 0) {
      appointmentList.innerHTML = '<p class="no-appointments">No upcoming appointments.</p>';
    }

    alert('Appointment cancelled.');
  } catch (err) {
    console.error('Cancel error:', err);
    alert('Failed to cancel appointment. Please try again.');
  }
};

  window.rescheduleAppointment = async (id) => {
    const newDate = prompt('New date (YYYY-MM-DD):');
    const newTime = prompt('New time (HH:MM):');
    if (!newDate || !newTime) return;

    try {
      const res = await fetch(`${API_BASE}/${id}`);
      const appointment = await res.json();
      const newSlot = `${newTime}-${formatEndTime(newTime)}`;

      const allRes = await fetch(API_BASE);
      const appointments = await allRes.json();
      const isTaken = appointments.some(app =>
        app.doctorId === appointment.doctorId &&
        app.date === newDate &&
        app.timeSlot === newSlot &&
        ['pending', 'confirmed'].includes(app.status) &&
        app._id !== id
      );

      if (isTaken) return alert('Time already booked.');

      await fetch(`${API_BASE}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date: newDate, timeSlot: newSlot, status: 'pending' })
      });

      const user = JSON.parse(sessionStorage.getItem('user'));
      await sendAppointmentEmail(user.email, {
        appointment_id: id,
        patient_name: user.fullName,
        doctor_name: doctorMap[appointment.doctorId],
        appointment_date: formatDateParts(newDate).fullDate,
        appointment_time: newSlot,
        previous_date: formatDateParts(appointment.date).fullDate,
        previous_time: appointment.timeSlot,
        appointment_type: capitalize(appointment.appointmentType),
        appointment_reason: appointment.reason,
        patient_email: user.email
      }, 'reschedule');

      alert('Rescheduled successfully.');
      loadAppointments();
    } catch (err) {
      console.error('Reschedule error:', err);
    }
  };
});
</script>


</body>
</html>